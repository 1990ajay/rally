{%- set image_name = image_name|default("^(cirros.*uec|TestVM)$") %}
{%- set flavor_name = flavor_name|default("m1.tiny") %}
{%- set use_existing_users = use_existing_users|default(false) %}
{%- set service_list = service_list|default(["authentication", "cinder", "keystone"]) %}
{%- macro user_context(tenants=1,users_per_tenant=1) -%}
{%- if use_existing_users and caller is not defined -%} {}
{%- else %}
  {%- if not use_existing_users %}
        users:
          tenants: {{ tenants }}
          users_per_tenant: {{ users_per_tenant }}
  {%- endif %}
  {%- if caller is defined %}
    {{ caller() }}
  {%- endif %}
{%- endif %}
{%- endmacro %}
{%- macro vm_params(image=none, flavor=none, size=none) %}
{%- if flavor is not none %}
        flavor:
          name: {{ flavor }}
{%- endif %}
{%- if image is not none %}
        image:
          name: {{ image }}
{%- endif %}
{%- if size is not none %}
        size: {{ size }}
{%- endif %}
{%- endmacro %}
{%- macro unlimited_volumes() %}
          cinder:
            gigabytes: -1
            snapshots: -1
            volumes: -1
{%- endmacro %}
{%- macro runner(type='constant',concurrency=1,times=1) %}
        type: {{ type }}
        concurrency: {{ concurrency }}
        times: {{ times }}
{%- endmacro %}
{%- macro no_failures_sla() %}
        failure_rate:
          max: 0
{%- endmacro %}
{%- macro volumes(size=1, volumes_per_tenant=1) %}
        volumes:
          size: {{ size }}
          volumes_per_tenant: {{ volumes_per_tenant }}
{%- endmacro %}
---
{% if "authentication" in service_list %}
  Authenticate.keystone:
    -
      context:
        {{ user_context() }}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}
{% endif %}
{% if "cinder" in service_list %}
  CinderVolumes.create_and_attach_volume:
    -
      args:
        {{ vm_params(image_name,flavor_name,1) }}
      context:
        {% call user_context() %}
        quotas:
          {{ unlimited_volumes() }}
        {% endcall %}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  CinderVolumes.create_and_delete_snapshot:
    -
      args:
        force: false
      context:
        {% call user_context() %}
        quotas:
          {{ unlimited_volumes() }}
        {{ volumes() }}
        {% endcall %}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  CinderVolumes.create_and_delete_volume:
    -
      args:
        size:
          max: 1
          min: 1
      context:
        {% call user_context() %}
        quotas:
          {{ unlimited_volumes() }}
        {% endcall %}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}
    -
      args:
        {{ vm_params(image_name,none,1) }}
      context:
        {% call user_context() %}
        quotas:
          {{ unlimited_volumes() }}
        {% endcall %}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}
    -
      args:
        size: 1
      context:
        {% call user_context() %}
        quotas:
          {{ unlimited_volumes() }}
        {% endcall %}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  CinderVolumes.create_and_extend_volume:
    -
      args:
        new_size: 2
        size: 1
      context:
        {% call user_context() %}
        quotas:
          {{ unlimited_volumes() }}
        {% endcall %}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  CinderVolumes.create_and_list_snapshots:
    -
      args:
        detailed: true
        force: false
      context:
        {% call user_context() %}
        quotas:
          {{ unlimited_volumes() }}
        {{ volumes() }}
        {% endcall %}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  CinderVolumes.create_and_list_volume:
    -
      args:
        detailed: true
        {{ vm_params(image_name,none,1) }}
      context:
        {% call user_context() %}
        quotas:
          {{ unlimited_volumes() }}
        {% endcall %}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}
    -
      args:
        detailed: true
        size: 1
      context:
        {% call user_context() %}
        quotas:
          {{ unlimited_volumes() }}
        {% endcall %}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  CinderVolumes.create_and_upload_volume_to_image:
    -
      args:
        container_format: "bare"
        disk_format: "raw"
        do_delete: true
        force: false
        size: 1
      context:
        {% call user_context() %}
        quotas:
          {{ unlimited_volumes() }}
        {% endcall %}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  CinderVolumes.create_from_volume_and_delete_volume:
    -
      args:
        size: 1
      context:
        {% call user_context() %}
        quotas:
          {{ unlimited_volumes() }}
        {{ volumes() }}
        {% endcall %}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  CinderVolumes.create_nested_snapshots_and_attach_volume:
    -
      args:
        nested_level:
          max: 1
          min: 1
        size:
          max: 1
          min: 1
      context:
        {% call user_context() %}
        quotas:
          {{ unlimited_volumes() }}
        servers:
          {{ vm_params(image_name,flavor_name,none)|indent(2,true) }}
          servers_per_tenant: 1
        {% endcall %}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}
{% endif %}
{% if "keystone" in service_list %}
  KeystoneBasic.add_and_remove_user_role:
    -
      context:
        {{ user_context() }}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  KeystoneBasic.create_add_and_list_user_roles:
    -
      context:
        {{ user_context() }}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  KeystoneBasic.create_and_list_tenants:
    -
      args:
        name_length: 10
      context:
        {{ user_context() }}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  KeystoneBasic.create_and_delete_role:
    -
      context:
        {{ user_context() }}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  KeystoneBasic.create_and_delete_service:
    -
      context:
        {{ user_context() }}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  KeystoneBasic.get_entities:
    -
      context:
        {{ user_context() }}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}

  KeystoneBasic.create_update_and_delete_tenant:
    -
      args:
        name_length: 10
      context:
        {{ user_context() }}
      runner:
        {{ runner() }}
      sla:
        {{ no_failures_sla() }}
{% endif %}
